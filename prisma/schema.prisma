generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model DocCategory {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(100)
  slug        String        @unique @db.VarChar(100)
  description String?       @db.Text
  parentId    Int?          @map("parent_id")
  icon        String        @default("file-text") @db.VarChar(50)
  sortOrder   Int           @default(0) @map("sort_order")
  isVisible   Boolean       @default(true) @map("is_visible")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  parent      DocCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    DocCategory[] @relation("CategoryTree")
  documents   Document[]

  @@map("doc_categories")
}

model Document {
  id          Int          @id @default(autoincrement())
  title       String       @db.VarChar(255)
  slug        String       @unique @db.VarChar(255)
  content     String       @db.LongText
  excerpt     String?      @db.Text
  status      DocStatus    @default(draft)
  categoryId  Int?         @map("category_id")
  isPinned    Boolean      @default(false) @map("is_pinned")
  sortOrder   Int          @default(0) @map("sort_order")
  viewCount   Int          @default(0) @map("view_count")
  author      String       @default("admin") @db.VarChar(100)
  publishedAt DateTime?    @map("published_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  category    DocCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([status], map: "idx_status")
  @@index([categoryId], map: "idx_category")
  @@index([publishedAt], map: "idx_published")
  @@fulltext([title, content], map: "idx_search")
  @@map("documents")
}

enum DocStatus {
  draft
  published
  archived
}

// ========== Gateway Models ==========

model Source {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  baseUrl   String   @map("base_url") @db.VarChar(500)
  apiKey    String   @map("api_key") @db.VarChar(500)
  models    Json     @default("[]")
  priority  Int      @default(0)
  weight    Int      @default(1)
  status    Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  logs RequestLog[]

  @@map("sources")
}

model ModelConfig {
  id          Int      @id @default(autoincrement())
  modelId     String   @unique @map("model_id") @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(100)
  inputPrice  Decimal  @default(0) @map("input_price") @db.Decimal(12, 6)
  outputPrice Decimal  @default(0) @map("output_price") @db.Decimal(12, 6)
  rpm         Int      @default(60)
  tpm         Int      @default(100000)
  status      Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("model_configs")
}

model ApiKey {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(100)
  key            String    @unique @db.VarChar(100)
  status         Int       @default(1)
  allowedModels  Json      @default("[]") @map("allowed_models")
  totalQuota     Decimal   @default(0) @map("total_quota") @db.Decimal(12, 6)
  usedQuota      Decimal   @default(0) @map("used_quota") @db.Decimal(12, 6)
  dailyQuota     Decimal?  @map("daily_quota") @db.Decimal(12, 6)
  dailyUsed      Decimal   @default(0) @map("daily_used") @db.Decimal(12, 6)
  dailyResetAt   DateTime? @map("daily_reset_at")
  monthlyQuota   Decimal?  @map("monthly_quota") @db.Decimal(12, 6)
  monthlyUsed    Decimal   @default(0) @map("monthly_used") @db.Decimal(12, 6)
  monthlyResetAt DateTime? @map("monthly_reset_at")
  rpm            Int       @default(60)
  tpm            Int       @default(100000)
  expiredAt      DateTime? @map("expired_at")
  lastUsedAt     DateTime? @map("last_used_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  logs RequestLog[]

  @@map("api_keys")
}

model RequestLog {
  id               Int      @id @default(autoincrement())
  apiKeyId         Int      @map("api_key_id")
  keyName          String   @map("key_name") @db.VarChar(100)
  modelId          String   @map("model_id") @db.VarChar(100)
  sourceId         Int?     @map("source_id")
  promptTokens     Int      @default(0) @map("prompt_tokens")
  completionTokens Int      @default(0) @map("completion_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  cost             Decimal  @default(0) @db.Decimal(12, 6)
  latencyMs        Int      @default(0) @map("latency_ms")
  statusCode       Int      @default(200) @map("status_code")
  isStream         Boolean  @default(false) @map("is_stream")
  errorMsg         String?  @map("error_msg") @db.Text
  createdAt        DateTime @default(now()) @map("created_at")

  apiKey ApiKey  @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  source Source? @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([apiKeyId], map: "idx_api_key")
  @@index([modelId], map: "idx_model")
  @@index([createdAt], map: "idx_created")
  @@map("request_logs")
}
